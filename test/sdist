#!/bin/bash
#
# test/sdist: tests the package generated by "cabal sdist".
#
# Copyright (c) 2015-2018 Rudy Matela.
# Distributed under the 3-Clause BSD licence.
export LC_ALL=C  # consistent sort
pkgver=` cat *.cabal | grep "^version:" | sed -e "s/version: *//"`
pkgname=`cat *.cabal | grep "^name:"    | sed -e "s/name: *//"`
pkgbase=$pkgname-$pkgver
set -xe
cabal sdist &&
pkg=`find dist* -name $pkgbase.tar.gz`
tar -tf $pkg | sort --ignore-case          > ls-cabal-i  &&
tar -tf $pkg | sort --ignore-case --unique > ls-cabal-iu &&
diff -rud ls-cabal-i ls-cabal-iu &&
rm -f ls-cabal-i ls-cabal-iu &&
if [ -d .git ]
then
	# on git repo, test if files are the same
	git ls-files                                         | sort > ls-git   &&
	tar -tf $pkg | grep -v "/$" | sed -e "s,$pkgbase/,," | sort > ls-cabal &&
	diff -rud ls-git ls-cabal &&
	rm -f ls-git ls-cabal
fi
